services:
  # Frontend: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: chatbotgate-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - chatbotgate
    networks:
      - chatbotgate-network
    restart: unless-stopped

  # Middle: ChatbotGate authentication proxy
  chatbotgate:
    image: ideamans/chatbotgate:latest
    # For local development, uncomment the following and comment out the image line:
    # build:
    #   context: ../..
    #   dockerfile: Dockerfile
    container_name: chatbotgate-proxy
    volumes:
      - ./chatbotgate/config.yaml:/etc/chatbotgate/config.yaml:ro
    environment:
      - TZ=UTC
    depends_on:
      - backend
    networks:
      - chatbotgate-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4180/health"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  # Backend: Simple web application
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: chatbotgate-backend
    networks:
      - chatbotgate-network
    restart: unless-stopped

networks:
  chatbotgate-network:
    driver: bridge

# Example with persistent data using volumes:
# Uncomment to use LevelDB with persistent storage
#
# services:
#   chatbotgate:
#     volumes:
#       - chatbotgate-data:/var/lib/chatbotgate/kvs
#
# volumes:
#   chatbotgate-data:
