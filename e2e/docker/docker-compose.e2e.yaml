services:
  proxy-app:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: e2e-proxy-app
    command: ["serve", "--config", "/config/proxy.e2e.yaml", "--host", "0.0.0.0", "--port", "4180"]
    ports:
      - "4180:4180"
    depends_on:
      - target-app
      - stub-auth
      - mailpit
    volumes:
      - ../config/proxy.e2e.yaml:/config/proxy.e2e.yaml:ro
      - otp-files:/otp
    environment:
      - LANGUAGE=en
    networks:
      - e2e-net

  proxy-app-with-whitelist:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: e2e-proxy-app-with-whitelist
    entrypoint:
      - /bin/sh
      - -c
      - |
        cp /seed-config/proxy.e2e.with-whitelist.yaml /app/config/proxy.e2e.with-whitelist.yaml
        exec /app/chatbotgate serve --config /app/config/proxy.e2e.with-whitelist.yaml --host 0.0.0.0 --port 4180
    ports:
      - "4181:4180"  # Map external 4181 to internal 4180
    depends_on:
      - target-app
      - stub-auth
      - mailpit
    volumes:
      # Mount config as read-only seed, then copy to /app/config at startup
      - ../config/proxy.e2e.with-whitelist.yaml:/seed-config/proxy.e2e.with-whitelist.yaml:ro
      - otp-files:/otp
    environment:
      - LANGUAGE=en
    networks:
      - e2e-net

  proxy-app-with-forwarding:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: e2e-proxy-app-with-forwarding
    command: ["serve", "--config", "/config/proxy.e2e.with-forwarding.yaml", "--host", "0.0.0.0", "--port", "4180"]
    ports:
      - "4182:4180"  # Map external 4182 to internal 4180
    depends_on:
      - target-app
      - stub-auth
      - mailpit
    volumes:
      - ../config/proxy.e2e.with-forwarding.yaml:/config/proxy.e2e.with-forwarding.yaml:ro
      - otp-files:/otp
    environment:
      - LANGUAGE=en
    networks:
      - e2e-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4180/_auth/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  proxy-app-with-rules:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: e2e-proxy-app-with-rules
    command: ["serve", "--config", "/config/proxy.e2e.with-rules.yaml", "--host", "0.0.0.0", "--port", "4180"]
    ports:
      - "4183:4180"  # Map external 4183 to internal 4180
    depends_on:
      - target-app
      - stub-auth
      - mailpit
    volumes:
      - ../config/proxy.e2e.with-rules.yaml:/config/proxy.e2e.with-rules.yaml:ro
      - otp-files:/otp
    environment:
      - LANGUAGE=en
    networks:
      - e2e-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4180/_auth/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  proxy-app-with-password:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: e2e-proxy-app-with-password
    command: ["serve", "--config", "/config/proxy.e2e.password.yaml", "--host", "0.0.0.0", "--port", "4180"]
    ports:
      - "4184:4180"  # Map external 4184 to internal 4180
    depends_on:
      - target-app
    volumes:
      - ../config/proxy.e2e.password.yaml:/config/proxy.e2e.password.yaml:ro
    environment:
      - LANGUAGE=en
    networks:
      - e2e-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4180/_auth/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  proxy-app-custom-prefix:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: e2e-proxy-app-custom-prefix
    command: ["serve", "--config", "/config/proxy.e2e.custom-prefix.yaml", "--host", "0.0.0.0", "--port", "4180"]
    ports:
      - "4185:4180"  # Map external 4185 to internal 4180
    depends_on:
      - target-app-custom-prefix
      - stub-auth
      - mailpit
    volumes:
      - ../config/proxy.e2e.custom-prefix.yaml:/config/proxy.e2e.custom-prefix.yaml:ro
      - otp-files:/otp
    environment:
      - LANGUAGE=en
    networks:
      - e2e-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4180/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  target-app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.target-app
    container_name: e2e-target-app
    env_file:
      - ../config/target-app.env
    ports:
      - "13000:3000"  # Temporary: use 13000 to avoid conflict
    networks:
      - e2e-net

  target-app-custom-prefix:
    build:
      context: ..
      dockerfile: docker/Dockerfile.target-app
    container_name: e2e-target-app-custom-prefix
    env_file:
      - ../config/target-app.env
    environment:
      - AUTH_PATH_PREFIX=/_oauth2_proxy
      - TARGET_APP_NAME=Target App (Custom Prefix)
    ports:
      - "13001:3000"  # Separate port for custom prefix target app
    networks:
      - e2e-net

  stub-auth:
    build:
      context: ..
      dockerfile: docker/Dockerfile.stub-auth
    container_name: e2e-stub-auth
    env_file:
      - ../config/stub-auth.env
    ports:
      - "3001:3001"
    networks:
      - e2e-net

  mailpit:
    image: axllent/mailpit:latest
    container_name: e2e-mailpit
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    environment:
      - MP_SMTP_AUTH_ACCEPT_ANY=1
      - MP_SMTP_AUTH_ALLOW_INSECURE=1
    networks:
      - e2e-net
    restart: unless-stopped

networks:
  e2e-net:
    driver: bridge

volumes:
  otp-files:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ../tmp
  test-results:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ../test-results
