# E2E Test configuration for custom field forwarding with encryption
service:
  name: "ChatbotGate E2E Test - Custom Forwarding (Encrypted)"
  description: "E2E test for encrypted custom field forwarding based on OAuth2 scopes"

server:
  auth_path_prefix: "/_auth"

# Proxy to test backend server
proxy:
  upstream:
    url: "http://localhost:8083"

# Session configuration
session:
  cookie_name: "_oauth2_proxy_e2e_custom_encrypted"
  cookie_secret: "e2e-test-cookie-secret-key-32-chars-long-12345678"
  cookie_expire: "1h"
  cookie_secure: false
  cookie_httponly: true
  cookie_samesite: "lax"

# OAuth2 providers (mock for testing)
oauth2:
  providers:
    - name: "test-provider-with-analytics"
      type: "custom"
      display_name: "Test Provider (Analytics Scope)"
      client_id: "test-client-id"
      client_secret: "test-client-secret"
      auth_url: "http://localhost:9999/oauth/authorize"
      token_url: "http://localhost:9999/oauth/token"
      userinfo_url: "http://localhost:9999/oauth/userinfo"
      insecure_skip_verify: true
      # Request analytics scope to get additional fields
      scopes:
        - "openid"
        - "email"
        - "profile"
        - "analytics"  # This will trigger stub-auth to return secrets.access_token
      # Forward custom fields from OAuth2 response
      forwarding:
        custom:
          # Forward access token via header
          - path: "secrets.access_token"
            header: "X-Access-Token"
          # Forward access token via query (only on login redirect)
          - path: "secrets.access_token"
            query: "access_token"
          # Forward analytics user_id via header
          - path: "analytics.user_id"
            header: "X-Analytics-User-Id"
          # Test missing path (should not send anything)
          - path: "nonexistent.field"
            header: "X-Should-Not-Exist"
          # Test header-only forwarding (no query)
          - path: "analytics.tier"
            header: "X-Analytics-Tier"
          # Test query-only forwarding (no header)
          - path: "secrets.refresh_token"
            query: "refresh_token"

# Email authentication (disabled for this test)
email_auth:
  enabled: false

# Authorization (allow all for testing)
authorization:
  allowed: []

# Logging
logging:
  level: "debug"
  module_level: "debug"
  color: true

# KVS configuration (memory for testing)
kvs:
  default:
    type: "memory"
    memory:
      cleanup_interval: "1m"

# Global user information forwarding with encryption enabled
forwarding:
  # Forward both username and email
  fields:
    - "username"
    - "email"

  # QueryString forwarding (ENCRYPTED)
  querystring:
    enabled: true
    encrypt: true

  # Header forwarding (ENCRYPTED)
  header:
    enabled: true
    encrypt: true
    prefix: "X-Chatbotgate-"

  # Encryption configuration
  encryption:
    key: "e2e-test-encryption-key-32-chars-long-1234567890"
