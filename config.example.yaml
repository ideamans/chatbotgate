# chatbotgate configuration example
# Copy this file to config.yaml and customize for your environment

# Service information
service:
  name: "ChatbotGate"
  description: "Authentication proxy for multiple OAuth2 providers"
  # Optional: Icon URL for auth header (48px icon, appears to the left of title)
  # icon_url: "https://example.com/icon.svg"
  # Optional: Logo URL for auth header (larger logo image, appears above title)
  # logo_url: "https://example.com/logo.svg"
  # Optional: Logo width (default: "200px", examples: "100px", "150px", "300px")
  # logo_width: "200px"

# HTTP server configuration
# Note: host and port are now set via command-line flags (-host, -port)
# Default values: host=0.0.0.0, port=4180
server:
  # Authentication path prefix (default: "/_auth")
  # All authentication endpoints will use this prefix
  # auth_path_prefix: "/_auth"

  # Base URL for email links and redirects (optional)
  # Used for email authentication login links
  # If not set, defaults to http://host:port (e.g., http://localhost:4180)
  # Set this when running behind a reverse proxy or using a different external URL
  # base_url: "https://auth.example.com"

  # OAuth2 callback URL override (optional)
  # Used for OAuth2 provider callback redirects
  # If not set, defaults to http://host:port/_auth/oauth2/callback
  # Set this when the external callback URL differs from the internal URL
  # callback_url: "https://auth.example.com/_auth/oauth2/callback"

# Proxy configuration
proxy:
  # Main upstream backend (required)
  upstream:
    url: "http://localhost:8080"
    # Optional: Secret header for upstream authentication
    # This header will be added to all requests to the upstream
    # Use this to protect your upstream from direct access
    secret:
      header: "X-Chatbotgate-Secret"
      value: "YOUR-SECRET-TOKEN-HERE"

# Session configuration
session:
  cookie_name: "_oauth2_proxy"
  # Generate a random secret: openssl rand -base64 32
  cookie_secret: "CHANGE-THIS-TO-A-RANDOM-SECRET-AT-LEAST-32-CHARACTERS-LONG"
  cookie_expire: "168h"  # 7 days
  cookie_secure: false   # Set to true when using HTTPS
  cookie_httponly: true
  cookie_samesite: "lax"

# OAuth2 providers configuration
oauth2:
  providers:
    # Google OAuth2
    - name: "google"
      display_name: "Google"
      client_id: "YOUR-GOOGLE-CLIENT-ID"
      client_secret: "YOUR-GOOGLE-CLIENT-SECRET"
      # Optional: Set disabled: true to hide from login page (default: false)
      # disabled: false
      # Optional: Custom icon URL (if not set, uses default Google icon)
      # icon_url: "https://example.com/custom-google-icon.svg"
      # Optional: Custom scopes (default: userinfo.email, userinfo.profile)
      # By default (reset_scopes: false), these scopes are ADDED to the default scopes
      # scopes:
      #   - "https://www.googleapis.com/auth/analytics.readonly"
      # Optional: Reset scopes (default: false)
      # If true, replaces default scopes with the specified scopes
      # If false (default), adds specified scopes to default scopes
      # reset_scopes: false

    # GitHub OAuth2
    - name: "github"
      display_name: "GitHub"
      client_id: "YOUR-GITHUB-CLIENT-ID"
      client_secret: "YOUR-GITHUB-CLIENT-SECRET"
      disabled: true  # Set to false to enable
      # Optional: Custom icon URL (if not set, uses default GitHub icon)
      # icon_url: "https://example.com/custom-github-icon.svg"
      # Optional: Custom scopes (default: user:email, read:user)
      # By default (reset_scopes: false), these scopes are ADDED to the default scopes
      # scopes:
      #   - "repo"
      # Optional: Reset scopes (default: false)
      # reset_scopes: false

    # Microsoft OAuth2 (Azure AD)
    - name: "microsoft"
      display_name: "Microsoft"
      client_id: "YOUR-MICROSOFT-CLIENT-ID"
      client_secret: "YOUR-MICROSOFT-CLIENT-SECRET"
      disabled: true  # Set to false to enable
      # Optional: Custom icon URL (if not set, uses default Microsoft icon)
      # icon_url: "https://example.com/custom-microsoft-icon.svg"
      # Optional: Custom scopes (default: openid, profile, email, User.Read)
      # By default (reset_scopes: false), these scopes are ADDED to the default scopes
      # scopes:
      #   - "Calendars.Read"
      # Optional: Reset scopes (default: false)
      # reset_scopes: false

    # Custom OIDC Provider Example
    # - name: "custom-oidc"
    #   type: "custom"
    #   display_name: "My OIDC Provider"
    #   client_id: "YOUR-CLIENT-ID"
    #   client_secret: "YOUR-CLIENT-SECRET"
    #   disabled: true  # Set to false to enable
    #   # Custom icon URL is especially useful for custom OIDC providers
    #   icon_url: "https://your-provider.com/logo.svg"
    #   auth_url: "https://your-provider.com/oauth/authorize"
    #   token_url: "https://your-provider.com/oauth/token"
    #   userinfo_url: "https://your-provider.com/oauth/userinfo"
    #   # Optional: JWKS URL for token validation
    #   # jwks_url: "https://your-provider.com/.well-known/jwks.json"
    #   # Allow HTTP for local testing (default: false, use only for development)
    #   # insecure_skip_verify: true

# Email authentication configuration (Phase 2)
email_auth:
  enabled: true

  # Sender type: "smtp" or "sendgrid"
  sender_type: "smtp"

  # SMTP configuration (when sender_type: "smtp")
  smtp:
    host: "smtp.gmail.com"
    port: 587
    username: "your-email@gmail.com"
    password: "your-app-password"
    from: "noreply@example.com"
    from_name: "ChatbotGate"
    tls: false
    starttls: true

  # SendGrid configuration (when sender_type: "sendgrid")
  # sendgrid:
  #   api_key: "SG.xxxxxxxxxxxxxxxxxxxx"
  #   from: "noreply@example.com"
  #   from_name: "ChatbotGate"
  #   # Optional: Custom endpoint URL (default: https://api.sendgrid.com)
  #   # Useful for proxies, testing, or internal infrastructure routing
  #   # endpoint_url: "https://custom-sendgrid-proxy.example.com"

  # Token expiration
  token:
    expire: "15m"  # 15 minutes

# Authorization configuration
authorization:
  # Allowed email addresses and domains
  # Entries starting with @ are domains, others are email addresses
  # Leave empty [] to allow all authenticated users (no whitelist)
  allowed:
    - "user@example.com"
    - "admin@company.com"
    - "@example.org"
    - "@company.com"

# Logging configuration
logging:
  level: "info"         # debug, info, warn, error
  module_level: "debug" # Log level for sub-modules
  color: true           # Enable colored output (auto-detects TTY)

# KVS (Key-Value Store) configuration
# Used for session storage, OTP tokens, and rate limiting
#
# Design: Single shared KVS backend with namespace isolation (recommended),
# or dedicated backends for each use case (optional overrides).
kvs:
  # Default KVS configuration (shared by all use cases)
  # Sessions, tokens, and rate limits will use this backend with different namespace prefixes
  default:
    type: "memory"  # "memory", "leveldb", or "redis"

    # Memory-specific config (used when type: "memory")
    memory:
      cleanup_interval: "5m"  # How often to clean up expired keys

    # LevelDB-specific config (used when type: "leveldb")
    # leveldb:
    #   path: "/var/lib/chatbotgate/kvs"  # Storage path (empty = OS cache/temp dir)
    #   sync_writes: false  # Enable for safer writes (slower performance)
    #   cleanup_interval: "5m"  # Background cleanup for expired keys

    # Redis-specific config (used when type: "redis")
    # redis:
    #   addr: "localhost:6379"
    #   password: ""
    #   db: 0
    #   pool_size: 0  # 0 = default (10 * CPU cores)

  # Namespace names for logical isolation (optional, defaults shown below)
  # Each namespace gets isolated storage:
  # - Memory: separate instance per namespace
  # - LevelDB: separate directory per namespace
  # - Redis: key prefix (namespace:key format)
  namespaces:
    session: "session"        # Namespace name for sessions
    token: "token"            # Namespace name for OTP tokens
    ratelimit: "ratelimit"    # Namespace name for rate limits

  # Optional: Override session storage with dedicated backend
  # If not specified, uses default KVS with "session" namespace
  # session:
  #   type: "redis"
  #   redis:
  #     addr: "localhost:6379"
  #     db: 1
  #     pool_size: 20

  # Optional: Override token storage with dedicated backend
  # If not specified, uses default KVS with "token:" prefix
  # token:
  #   type: "memory"
  #   memory:
  #     cleanup_interval: "1m"

  # Optional: Override rate limit storage with dedicated backend
  # If not specified, uses default KVS with "ratelimit:" prefix
  # ratelimit:
  #   type: "leveldb"
  #   leveldb:
  #     path: "/var/lib/chatbotgate/ratelimit"

# User information forwarding configuration
# Forward authenticated user information to upstream applications
forwarding:
  # Optional: Encryption settings (required if any field uses 'encrypt' filter)
  # encryption:
  #   key: "CHANGE-THIS-TO-A-RANDOM-KEY-AT-LEAST-32-CHARACTERS"  # Must be at least 32 characters
  #   algorithm: "aes-256-gcm"  # Default: "aes-256-gcm"

  # Field forwarding definitions
  # Each field specifies:
  # - path: Dot-separated path to the field (e.g., "email", "extra.avatar_url", "." for entire object)
  # - query: Query parameter name for login redirect (optional)
  # - header: HTTP header name for all requests (optional)
  # - filters: Processing filters (optional, e.g., "encrypt,zip" or ["encrypt", "zip"])
  #
  # At least one of 'query' or 'header' must be specified for each field.
  #
  # Available filters:
  # - encrypt: AES-256-GCM encryption (requires encryption config)
  # - zip: gzip compression
  # - base64: base64 encoding (auto-added if final output is binary)
  #
  # Filter processing order: left to right (e.g., "encrypt,zip" â†’ encrypt first, then zip)
  # Final output is automatically base64-encoded if binary.
  fields:
    # Example 1: Forward email as query parameter and header (plain text)
    # - path: email
    #   query: email
    #   header: X-Auth-Email

    # Example 2: Forward username with encryption
    # - path: username
    #   header: X-Auth-User
    #   filters: encrypt

    # Example 3: Forward email with encryption and compression
    # - path: email
    #   query: user_email
    #   header: X-Auth-Email
    #   filters: encrypt,zip

    # Example 4: Forward avatar URL from OAuth2 extra data
    # - path: extra.avatar_url
    #   header: X-Avatar-URL

    # Example 5: Forward entire user object as JSON (encrypted and compressed)
    # - path: .
    #   query: userinfo
    #   filters:
    #     - encrypt
    #     - zip

    # Example 6: Forward access token from OAuth2 provider
    # - path: extra.secrets.access_token
    #   header: X-Access-Token
    #   filters: encrypt,zip

    # Example 7: Forward provider name
    # - path: provider
    #   header: X-Auth-Provider

# Passthrough configuration
# Paths matching these patterns will bypass authentication
# Useful for public assets, API endpoints, or embedding widgets
passthrough:
  # Exact prefix matches
  # Any path starting with these prefixes will skip authentication
  prefix:
    # - "/embed.js"
    # - "/public/"
    # - "/static/"

  # Regular expression patterns
  # Paths matching these regex patterns will skip authentication
  regex:
    # - "^/api/public/.*$"
    # - "\.js$"
    # - "^/v\\d+/.*$"

  # Minimatch/glob patterns
  # Supports *, **, ?, and brace expansion
  # ** matches across path separators, * matches within a segment
  minimatch:
    # - "/**/*.js"       # All .js files at any depth
    # - "/**/*.css"      # All .css files at any depth
    # - "/static/**"     # Everything under /static/
    # - "/api/**/public" # /api/public, /api/v1/public, etc.
